name: Deploy to GKE (Immutable SHA)

on:
  workflow_run:
    workflows: ["Build & Push Docker Images"]
    types:
      - completed

env:
  PROJECT_ID: dgi-cosmic-20251210-1542
  CLUSTER_NAME: dgi-cluster
  REGION: us-central1
  NAMESPACE: production

  REGISTRY: ghcr.io
  OWNER: tsramb23
  IMAGE_BACKEND: dgi-netwatch-backend
  IMAGE_FRONTEND: dgi-netwatch-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Install GKE Auth Plugin
        run: gcloud components install gke-gcloud-auth-plugin

      - name: Configure kubectl
        run: gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --region ${{ env.REGION }} --project ${{ env.PROJECT_ID }}

      - name: Export IMAGE_TAG from workflow_run SHA
        run: echo "IMAGE_TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
      
      - name: Apply Kubernetes manifests (structure)
        run: |
          kubectl apply -f k8s/service-backend.yaml
          kubectl apply -f k8s/service-frontend-loadbalancer.yaml
          kubectl apply -f k8s/deployment-backend-frontend.yaml
          
      - name: Deploy backend and frontend with immutable tag
        run: |
          kubectl -n ${{ env.NAMESPACE }} set image deployment/dgi-netwatch-backend \
            backend=${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_BACKEND }}:${IMAGE_TAG}

          kubectl -n ${{ env.NAMESPACE }} set image deployment/dgi-netwatch-frontend \
            frontend=${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_FRONTEND }}:${IMAGE_TAG}

      - name: Wait for rollout
        run: |
          kubectl -n ${{ env.NAMESPACE }} rollout status deployment/dgi-netwatch-backend --timeout=300s
          kubectl -n ${{ env.NAMESPACE }} rollout status deployment/dgi-netwatch-frontend --timeout=300s

      - name: Verify pods and image IDs
        run: |
          kubectl -n ${{ env.NAMESPACE }} get pods -o wide
          echo "----- Backend Image -----"
          kubectl -n ${{ env.NAMESPACE }} describe pod -l app=dgi-netwatch-backend | sed -n '/Image:/p;/Image ID:/p'
          echo "----- Frontend Image -----"
          kubectl -n ${{ env.NAMESPACE }} describe pod -l app=dgi-netwatch-frontend | sed -n '/Image:/p;/Image ID:/p'
